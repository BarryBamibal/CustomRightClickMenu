language: node_js
node_js: node
branches:
  only:
  - master
  - beta
  - reset
  - polymer-2
stages:
- build
- test
- name: deploy website
  if: branch = master

env:
  matrix:
  - TEST=test:chrome:old:page
  - TEST=test:chrome:old:extension
  - TEST=test:chrome:latest:page
  - TEST=test:chrome:latest:extension
  - TEST=test:firefox:quantum
  - TEST=test:firefox:latest
  - TEST=test:edge:16
  - TEST=test:edge:latest
  - TEST=test-build
  - TEST=test-local
  - TEST=test:chrome:old:install:greasyfork
  - TEST=test:chrome:old:install:openuserjs
  - TEST=test:chrome:old:install:userscriptsorg
  - TEST=test:chrome:old:install:userstylesorg
  - TEST=test:chrome:latest:install:greasyfork
  - TEST=test:chrome:latest:install:openuserjs
  - TEST=test:chrome:latest:install:userscriptsorg
  - TEST=test:chrome:latest:install:userstylesorg
  - TEST=test-migration:2.0.12
  - TEST=test-migration:2.0.13
  - TEST=test-migration:2.0.14
  - TEST=test-migration:2.0.15
  - TEST=test-migration:2.0.16
  - TEST=test-migration:2.0.17
  - TEST=test-migration:2.0.18
  - TEST=test-migration:2.0.19
  global:
  - secure: iPVXFxcVzOVCVVpWq0bxGGttAFjfQdmUaYlq25qeRQ4vf7KMJ749zBxd7PHy3c2TSD3nygt7MZmCRLnbyGnwqvDmPf7+FfFLTKL40vQXGFQzPnHrDTSpituNhU1uNZWsoWtCwzii+8ic14weWxfJwOqByhiotEBxY9oOxmLwLg1hiAoHtEXmGrnORdiro82iDpFiV4bgjqw+928/2I/wKpLfRbYAK1/zyFG5L5m/iod/VrNrvo1VPaDaip7F25OJN0S1J4kTbs5mHjqC0/oWYnGz3+1xm/3W/IUwsbFo85g5VqdjImrkaUzF2QGO3egSNV0ltbf/azi5Y59FOLkZ80NuBwAWs454QXLEH7nFBfznCTOi4JtxgmWjHYcrhUC1/Aoxye/inbqw7v9xP8tMMuBEeiXaiSgdaS4CgxeiQOzUJNquYldMhCYdy3F1qTTNmv3zXGIlkWY5UToAR0LqjR92QKkeAG0/BelW7nr4Gb2+EqluLeJfXlksb5gXqg4EIhi+/7GILRgEMiDwx2AqnkZMf87m2qSGWQ81l8m4cTueTDbNdt03vY+Obs/lzFMdujrvR+Xsq2abEG13D5zkQ/aJ2pd+4p2LtlVGr9j8E5owRhRn3//O2PodlSW6ydzIRdOzCh599XEMT0hHVVVMDVjEMtYD2/BddaV9+z9/lIs=
  - secure: oMBK1XL3gxnRE4+QABMPxSseQE3q/mUDjEGJJ7CnRU2WBSrv+sgcVMjXy+gvCNdT0297THiAjiEc8imFbLJSjLvjhl+sEQA63XTra7xyZfc4ZoglzBmEJe8LxvVJpIcmUCNEQYRPrjocIX+yZqbGfe/R6/U5okiKyBpUP7NF4ouTZ9vrNpWBA/uqCVoXqxrOhFMdEQyL6uaglmQN96M8SOTesnMjm0z7NnfJEyMD/gW+kAovC878QmZNVF0dNJYsolgqS/9aXcciFqH5Pv8qpK+H+wAMM81hOq9r7uZ3evueIucqXTO5h68SE/HdSAM4WQf+jeVz3H2+7vpqLMO9q3caEUJ9bdUCvYVv4rIiB8ud94/lTsSooPeCqrLllMTbvE385HKkr02NlsF52lUS2gKKo3+pYQK3vyedCcWNSxIeqDaEoo1FK4oANmIVXFAgWzq3RaHgzUxXLuZv4+nFMFq0wAKO0swBD9VYbcu0l7+dclMhXjSN8TQE7iB39T0jRm/oyDlDcBdF4YJmvgrSpR8YmJyD3ahuy9atnF4SMthGEp6ZTJVrD1GUqMqy+QYH0qmQ/EcLeIWY1p8PdPdA3DTJKDzKNTRwkGh4ujS5FAgGTzFtvQfqrzr5YOpGzTWm3gIHohKcEsuso5vliIv7zUVguljuxdf+nWA3qDiBFQA=
before_install:
- if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then 
  openssl aes-256-cbc -K $encrypted_6cd0c378df83_key
  -iv $encrypted_6cd0c378df83_iv -in test/UI/secrets.js.enc 
  -out test/UI/secrets.js -d; 
  fi
- npm install gulp -g
install:
- yarn --ignore-engines
script:
- gulp compile
- gulp stashBrowser && gulp browserChrome
- ./scripts/get_build_artifacts.sh || travis_wait sh ./scripts/pretest.sh
- ./scripts/do_test.sh $TEST
jobs:
  include:
  - stage: build
    script:
    - yarn pretest
    - ./scripts/set_build_artifacts.sh
  - stage: deploy website
    script:
    - if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then 
      ./scripts/is_latest_commit.sh && sh ./scripts/deploy-website.sh || echo "Not latest commit, not deploying"
      fi
    env: TEST=none
notifications:
  email:
    on_success: change
    on_failure: change
addons:
  apt:
    packages:
    - sshpass
  browserstack:
    username: sanderronde1
    access_key:
      secure: KWJzC2NH/w16xV/U5TXuQJZfSVdEJwsFR16uaSJRExtayAxpWWjR9WDHnnHskFJxlPgMSvL5++QoiKajWp1djUAUlElPFlNGeRrpQs19me+SqYkTmmsgn2T6JCo8ThyQRBWMC9k6tkrul7kOthPbEMrKcxsDckQGLIl9nc7LHxiT+iZ0ZV8oBdLELgqjFwsoCfZE9TeZlZybvFA7iUMIX6GxVTSDS3m6/ZN8CsosCIjboP96V7ZuAC2Yxb8klxUiEtqSBdyE6UqA8UMWoqERKp/b5V1BL69PT82TQBVpnrWgQzEw8dK1Lnr98w1a65xvx81VqQIqKx99HC4fYq54X1ajZXkYn6XpNM6UfQlSj2+mSGnzquiYwQrdvZ72HUo/oUfmE+wWIFPRlQYAPRCNjUViQLRPP3CH06Je4U+W0TOHHyQ4Cnd8DyX1HS0qEO3hmoptZMvpcFg+WZOpMhtKWrh6wNwZTxAndhe4vf974/JtoJBHaSqt4Nkllf9BisIUZqnj7I0HMyeJxlUc5m27wsf+NEKM6Qu3jybyBzCvic+D4jZOIzHbLZujKUNHpQmtvfllpBAAwcqjOa56gGgNo/n9CcdvQZqy0QhBMpThXBxW2vOYhVc21zJsa2BnNtZXrliWxrN/hJoIiqZdPdU8gDdLG2YiVOgKURALQSwDwuk=